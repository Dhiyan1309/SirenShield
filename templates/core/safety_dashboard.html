{% extends 'base.html' %}
{% load static %}

{% block title %}Safety Dashboard - SirenShield{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<style>
    .card {
        position: relative;
        overflow: hidden;
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
    }
    .card::after {
        content: 'SirenShield';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-30deg);
        font-size: 5rem;
        font-weight: 900;
        color: rgba(74, 144, 226, 0.15);
        white-space: nowrap;
        pointer-events: none;
        z-index: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        letter-spacing: 2px;
    }
    .card-body {
        position: relative;
        z-index: 1;
        background-color: rgba(255, 255, 255, 0.8);
    }
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-active {
        background-color: #28a745;
        box-shadow: 0 0 10px #28a745;
    }
    #map {
        height: 400px;
        width: 100%;
        min-height: 400px;
        border-radius: 8px;
        z-index: 1;
    }
    .leaflet-container {
        height: 100%;
        width: 100%;
    }
    .danger-confirmation {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
        z-index: 1000;
        text-align: center;
        max-width: 400px;
        width: 90%;
    }
    .danger-confirmation h4 {
        color: #dc3545;
        margin-bottom: 1rem;
    }
    .danger-confirmation .btn-group {
        margin-top: 1.5rem;
    }
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }
</style>
{% endblock %}

{% block content %}
<!-- Danger Confirmation Dialog -->
<div class="overlay" id="overlay"></div>
<div class="danger-confirmation" id="dangerConfirmation">
    <h4><i class="fas fa-exclamation-triangle"></i> Danger in Voice Detected</h4>
    <p>Should emergency alert messages be activated?</p>
    <div class="btn-group">
        <button class="btn btn-success" onclick="confirmEmergencyAlert(true)">
            <i class="fas fa-check"></i> Yes
        </button>
        <button class="btn btn-secondary" onclick="confirmEmergencyAlert(false)">
            <i class="fas fa-times"></i> No
        </button>
    </div>
</div>

<div class="container mt-4">
    <!-- Voice Detection Status -->
    <div class="mb-3">
        <span id="voiceDetectionStatus" class="fw-bold text-primary">No danger in voice detected.</span>
    </div>
    <!-- Alert Notifications -->
    <div id="alertNotifications" class="mb-4">
        <!-- Alerts will be dynamically inserted here -->
    </div>

    <div class="row">
        <!-- Status Card -->
        <div class="col-md-4 mb-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Safety Status</h5>
                    <div class="d-flex align-items-center mb-3">
                        <div class="safety-indicator active me-2"></div>
                        <span id="safetyStatus">Safety Mode Active</span>
                    </div>
                    <div class="alert-status mb-3">
                        <p><strong>Voice Monitoring:</strong> <span id="voiceStatus">Checking...</span></p>
                        <p><strong>Location Tracking:</strong> <span id="locationStatus">Active</span></p>
                    </div>
                    <form method="post" action="{% url 'deactivate_safety_mode' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="fas fa-power-off"></i> Deactivate Safety Mode
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Map Card -->
        <div class="col-md-8 mb-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Your Location</h5>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nearby Police Stations -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Nearby Police Stations</h5>
                    <div id="policeStations" class="row">
                        <!-- Police stations will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Template -->
<template id="alertTemplate">
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Emergency Alert!</strong>
        <p class="mb-0" id="alertMessage"></p>
        <p class="mb-0"><small>Alert sent to guardians and police stations.</small></p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let map = null;
    let userMarker = null;
    let accuracyCircle = null;
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];

    // Initialize map
    function initMap() {
        console.log('Initializing map...');
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found!');
            return;
        }
        
        try {
            map = L.map('map').setView([0, 0], 15);
            console.log('Map object created:', map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            console.log('Tile layer added');

            // Get user's location
            if (navigator.geolocation) {
                console.log('Geolocation is supported');
                navigator.geolocation.watchPosition(
                    function(position) {
                        console.log('Got position:', position);
                        const { latitude, longitude, accuracy } = position.coords;
                        
                        // Update map view
                        map.setView([latitude, longitude], 15);
                        console.log('Map view updated to:', latitude, longitude);
                        
                        // Update or create marker
                        if (userMarker) {
                            userMarker.setLatLng([latitude, longitude]);
                            accuracyCircle.setLatLng([latitude, longitude]);
                            accuracyCircle.setRadius(accuracy);
                        } else {
                            userMarker = L.marker([latitude, longitude]).addTo(map);
                            accuracyCircle = L.circle([latitude, longitude], {
                                radius: accuracy,
                                color: 'blue',
                                fillColor: '#3388ff',
                                fillOpacity: 0.2
                            }).addTo(map);
                        }
                        console.log('Marker and accuracy circle updated');
                        
                        // Find nearby police stations
                        findNearbyPoliceStations(latitude, longitude);
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                        showAlert('Error getting your location. Please check your location settings.', 'warning');
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser');
                showAlert('Geolocation is not supported by your browser.', 'warning');
            }
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    // Find nearby police stations
    function findNearbyPoliceStations(lat, lon) {
        const query = `
            [out:json][timeout:25];
            (
              node["amenity"="police"](around:5000,${lat},${lon});
            );
            out body;
            >;
            out skel qt;
        `;

        fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            body: query
        })
        .then(response => response.json())
        .then(data => {
            const stationsContainer = document.getElementById('policeStations');
            stationsContainer.innerHTML = '';
            
            data.elements.forEach(station => {
                const stationCard = document.createElement('div');
                stationCard.className = 'col-md-4 mb-3';
                stationCard.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${station.tags.name || 'Police Station'}</h6>
                            <p class="card-text">
                                ${station.tags['addr:street'] || 'Address not available'}<br>
                                ${station.tags.phone || 'Phone not available'}
                            </p>
                            <a href="https://www.openstreetmap.org/?mlat=${station.lat}&mlon=${station.lon}#map=15/${station.lat}/${station.lon}" 
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                Get Directions
                            </a>
                        </div>
                    </div>
                `;
                stationsContainer.appendChild(stationCard);
                
                // Add marker to map
                L.marker([station.lat, station.lon])
                    .bindPopup(station.tags.name || 'Police Station')
                    .addTo(map);
            });
        })
        .catch(error => {
            console.error('Error finding police stations:', error);
            showAlert('Error finding nearby police stations.', 'warning');
        });
    }

    // Show alert notification
    function showAlert(message, type = 'danger') {
        const alertContainer = document.getElementById('alertNotifications');
        const template = document.getElementById('alertTemplate');
        const alertElement = template.content.cloneNode(true);
        
        alertElement.querySelector('#alertMessage').textContent = message;
        alertContainer.appendChild(alertElement);
        
        // Auto-dismiss after 10 seconds
        setTimeout(() => {
            const alert = alertContainer.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 10000);
    }

    // Check voice monitoring status
    function checkVoiceMonitoringStatus() {
        fetch('/voice-monitoring-status/')
            .then(response => response.json())
            .then(data => {
                const voiceStatusElement = document.getElementById('voiceStatus');
                if (data.is_monitoring) {
                    voiceStatusElement.textContent = 'Active';
                    voiceStatusElement.className = 'text-success';
                } else {
                    voiceStatusElement.textContent = 'Inactive';
                    voiceStatusElement.className = 'text-danger';
                }
            })
            .catch(error => {
                console.error('Error checking voice monitoring status:', error);
                const voiceStatusElement = document.getElementById('voiceStatus');
                voiceStatusElement.textContent = 'Error';
                voiceStatusElement.className = 'text-warning';
            });
    }

    // Initialize voice monitoring status check
    function initVoiceMonitoring() {
        // Check status immediately
        checkVoiceMonitoringStatus();
        
        // Check status every 10 seconds
        setInterval(checkVoiceMonitoringStatus, 10000);
    }

    // Check for emergency alerts
    function checkEmergencyAlerts() {
        fetch('/check-emergency-alerts/')
            .then(response => response.json())
            .then(data => {
                if (data.has_emergency) {
                    // Emergency detected - trigger frontend actions
                    handleEmergencyDetection();
                    
                    // Mark this alert as processed to avoid repeated triggers
                    console.log('Emergency alert detected:', data.description);
                }
            })
            .catch(error => {
                console.error('Error checking emergency alerts:', error);
            });
    }
    
    // Initialize emergency alert checking
    function initEmergencyAlertChecking() {
        // Check for emergency alerts every 3 seconds
        setInterval(checkEmergencyAlerts, 3000);
    }

    // Show danger confirmation dialog
    let lastLocation = null;
    function showDangerConfirmation(location) {
        lastLocation = location;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('dangerConfirmation').style.display = 'block';
    }

    // Handle emergency alert confirmation
    function confirmEmergencyAlert(activate) {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('dangerConfirmation').style.display = 'none';
        if (activate && lastLocation) {
            console.log('Sending emergency alert with location:', lastLocation);
            fetch('/emergency-alert/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    latitude: lastLocation.latitude,
                    longitude: lastLocation.longitude,
                    map_link: `https://maps.google.com/?q=${lastLocation.latitude},${lastLocation.longitude}`
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('Emergency alert sent to guardian with your location!', 'success');
                    updateStatus('voiceStatus', 'Emergency Alert Sent');
                } else {
                    showAlert('Error sending emergency alert. Please try again.', 'danger');
                    updateStatus('voiceStatus', 'Error Sending Alert');
                }
            })
            .catch(error => {
                console.error('Error sending emergency alert:', error);
                showAlert('Error sending emergency alert. Please try again.', 'danger');
                updateStatus('voiceStatus', 'Error Sending Alert');
            });
        } else {
            updateStatus('voiceStatus', 'Monitoring');
            showAlert('Thank you for confirming your safety.', 'success');
        }
    }

    // Function to open maps to nearest police station
    function openNearestPoliceStation() {
        if (userMarker) {
            const userLat = userMarker.getLatLng().lat;
            const userLng = userMarker.getLatLng().lng;
            
            // Find nearest police station and open navigation
            fetch(`/police-stations/?lat=${userLat}&lon=${userLng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.stations && data.stations.length > 0) {
                        const nearestStation = data.stations[0];
                        const navigationUrl = `https://maps.google.com/?q=${nearestStation.lat},${nearestStation.lon}`;
                        window.open(navigationUrl, '_blank');
                        
                        // Show alert
                        showAlert(`Emergency detected! Opening navigation to nearest police station: ${nearestStation.name}`, 'danger');
                    } else {
                        showAlert('Emergency detected! No nearby police stations found.', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Error getting police stations:', error);
                    showAlert('Emergency detected! Unable to find nearby police stations.', 'warning');
                });
        }
    }
    
    // Function to handle emergency detection
    function handleEmergencyDetection() {
        // Open maps to nearest police station
        openNearestPoliceStation();
        
        // Show emergency alert
        showAlert('ðŸš¨ EMERGENCY ALERT: "Help me" detected! Emergency contacts have been notified and navigation to nearest police station opened.', 'danger');
        
        // Update status
        document.getElementById('voiceDetectionStatus').textContent = 'ðŸš¨ EMERGENCY DETECTED - Help me phrase recognized!';
        document.getElementById('voiceDetectionStatus').className = 'fw-bold text-danger';
    }

    // Initialize everything
    console.log('Initializing application...');
    initMap();
    initVoiceMonitoring();
    initEmergencyAlertChecking();
});
</script>
{% endblock %} 